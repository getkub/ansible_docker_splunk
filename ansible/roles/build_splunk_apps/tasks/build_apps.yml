---
# Playbook to create apps using templates

- name: Cleaning previous temporary directory
  file:
    path: "{{dest_base}}/{{project}}/{{bareApps}}"
    state: "{{item}}"
  with_items:
    - absent

# # This needs to be modified with correct permission set if you want to use in serious environment
- name: Creating Temporary directory
  file:
    path: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp"
    mode: "u=rwx,g=rwx,o=rwx"
    state: directory
    recurse: yes

# Copy files from template to bareApps in Temporary location
- name: Build necessary non-template files & directories
  synchronize:
    src:  "../files/{{env}}/"
    dest: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp"
    delete: yes

# Create host-specific directories too
- name: Creates Host-Specific directory
  file:
    state: directory
    path:  "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/{{hostname}}/{{ item[1] }}"
  with_nested:
    - "{{serverList_csv_dict.dict|dict2items}}"
    - ['etc/system/local', 'etc/apps']
  vars:
    - hostname: "{{item[0].value.hostname}}"
    - hostGroup: "{{item[0].value.hostGroup}}"
    - portMapping: "{{item[0].value.portMapping}}"
    - site_id: "{{item[0].value.site_id}}"

# Create hostnames based directories with configurations
# Directly update $SPLUNK_HOME/etc/system/local/ for certain configurations
- name:  Create host-specific conf files
  template:
    src: "{{item[1]}}"
    dest: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/{{hostname}}/etc/system/local/{{ item[1] | basename | regex_replace('.j2','') }}"
  with_nested:
    - "{{serverList_csv_dict.dict|dict2items}}"
    - "{{ lookup('fileglob', '../templates/system_local/*.j2').split(',') }}"
  vars:
    - hostname: "{{item[0].value.hostname}}"
    - hostGroup: "{{item[0].value.hostGroup}}"
    - portMapping: "{{item[0].value.portMapping}}"
    - site_id: "{{item[0].value.site_id}}"

# Complex one. Filetree and loop
- name: Create directory structure
  file:
    path: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp/{{item.path}}"
    state: directory
  with_items:
    - "{{ lookup('filetree', '../templates/common')}}"
    - "{{ lookup('filetree', '../templates/' + inputTag )}}"
  when:
    - item.state == 'directory'

- name: Copy templates to temp directory
  template:
    src:  "{{item.src}}/"
    dest: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp/{{item.path| dirname}}/{{item.path| basename | regex_replace('.j2','') }}"
  with_items:
    - "{{ lookup('filetree', '../templates/common')}}"
    - "{{ lookup('filetree', '../templates/' + inputTag )}}"
  when:
    - item.state == 'file'

# Copy temp to Individual servers
- name: Copy temp code to relevant host
  synchronize:
    src:  "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp/"
    dest: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/{{hostname}}/etc/apps/"
    delete: no
  loop:
    - "{{serverList_csv_dict.dict|dict2items}}"
  vars:
    - hostname: "{{item[0].value.hostname}}"
    - hostGroup: "{{item[0].value.hostGroup}}"
    - portMapping: "{{item[0].value.portMapping}}"
    - site_id: "{{item[0].value.site_id}}"

# cleanup temp directory to reduce confusion later
- name: Deleting Temporary directory
  file:
    path: "{{dest_base}}/{{project}}/{{bareApps}}/{{inputTag}}-specific/temp"
    state: absent
